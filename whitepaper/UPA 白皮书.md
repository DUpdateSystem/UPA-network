# UPA 白皮书

version: 0.9

# UPA：下一代软件分发平台

当 Android 系统的碎片化导致出现各类第三方应用市场时，高级用户们趋向于选择应用数量（Aptoide）、可信分发（Google play）、快速反馈（酷安/xda）的平台。但正如我们所见，因为“应用市场”平台没有固定收入的属性限制。以数量取胜的平台的渠道趋向混乱、用户自治，带来了重复分发、安装包质量低、用户操作繁琐的问题；以可信分发为基础的平台选择向开发者收取费用，其中包括广告、内购手续费、软件上架费用（Apple Store）等，对于用户而言，基于广告的推荐制度挤占心智，平台复杂的手续也阻止了一些开发者上架软件；以用户反馈为主的平台大多起源于专业论坛，基于此的应用市场因其应用数量限制而无法拓展用户（XDA），论坛与应用市场的目标用户不同易使得因应用资源吸引的用户容易稀释论坛高级用户及其开发者，并迫使高级用户离开平台（劣币驱逐良币）（酷安）。

因此，我们希望构建一个以用户的价值导向为基础，即基于**任务**（函数）为基础的P2P软件分发平台。我们认为平台/代币价值由用户需求的价值而非性能消耗（PoW）决定。着重面对应用数量、入场费用、价值积累（鼓励完成任务与发放任务）、选择性的内容拒绝（权限控制）、鼓励分支与合并分支、“代码即法律”（用户自治），维持平台的信息密度与信息可靠性。

其中，用户/开发者可以使用代币分发任务，或完成任务得到代币，并基于该原理实现：用户通过边际效应递减的原则廉价且动态支出代币来获取/传递信息，用户可选择只关注并维护自己喜好的数据，非中心化的移除不友好用户（惩罚不友好节点），可选择的强制中心化控制的支持，在必要情况下暂时/永久**分支网络**来创建自己的相对私有的网络，鼓励合并分支整个/部分网络并获得奖励代币，鼓励/支持使用无法保证可用性/廉价的设备，抑制中心化卡特尔组织（避免大型矿场）。

参考 ETH2、IPFS，该系统将使用 PoS （权益证明）的方式分发代币，并参考使用 ETH 帐号模型与 Filecoin 挖矿算法。

# 目录

- 历史
    - 标准的应用市场
- 数据存储
    - 对等式网络
        - BitTorrent
        - ZeroNet
    - 区块链
        - IPFS
        - Filecoin
    - 小结
- 挖矿
    - 比特币
    - 以太坊
    - 小结
- UPA 计算网络
- 应用
- 拓展性
    - 泛化功能
- 结论

# 历史

应用市场的概念伴随着应用而生，但应用市场的运行驱动模式与操作系统有强绑定。这导致操作系统官方推出应用市场有着强力的审核制度，软件相对稀少但有着良好的用户体验，而第三方应用市场应用繁多但用户体验一般，这是因为变现模式被限定为广告等流量入口的方式。

## 标准的应用市场

一个基础的应用市场（F-Droid）以服务器为基础，提供客户端需要的数据，包括软件的元数据（简介、版本信息、权限等），与安装包数据。客户端通过请求服务端数据实现下载、更新应用的功能。为加速访问速度，网站可以使用 CDN 技术加速客户端的访问。有时应用市场还提供评论等需要动态数据的接口，针对此类接口，服务端只能使用微服务等方式横向拓展接口容量。

![c_s.svg](./svg/c_s.svg)

这些操作的负荷集中于服务器，在这种C/S架构下，应用市场一方面本身为用户设计且希望拥有更多的用户，但另一方面用户本身又会导致更多的服务器负荷与维护花销。用户本身的参与无法像在社交平台上一样，为应用市场带来直接的内容与收入，相反大量的用户涌入将使应用市场陷入崩溃与巨额开销。在这种困境下，应用市场作为流量管道，只能收取类似于运营商的流量费用（强制广告、软件上架/内购费用），而这种行为却又降低了用户的使用体验与开发者的入驻体验而导致用户流失。

![c_s收入.svg](./svg/c_s%E6%94%B6%E5%85%A5.svg)

基于以上问题，我们期待建立一种类似于加密货币技术，由用户构成完整的系统且在用户使用行为中自发产生价值的内容分发网络。

# 数据传输

## **对等式网络**

对等式网络（P2P），又称点对点技术，是去中心化、依靠用户群（peers）交换信息的互联网体系。P2P在网络隐私要求高和文件共享领域中，得到了广泛的应用。不同于C/S模型，这种体系最大程度避免了因容量问题导致的故障。

### BitTorrent

BitTorrent 客户端的第一个版本没有搜索引擎，也没有对等交换。 直到 2005 年，共享文件的唯一方法是创建一个名为“ torrent ”的小文本文件，然后将其上传到 torrent 索引站点。 第一个上传者充当 种子 ，下载者最初将作为 对等 。 那些希望下载文件的人将下载种子，他们的客户端将使用该种子连接到一个跟踪器，该跟踪器具有群中其他种子和对等点的 IP 地址列表。 一旦对等点完成了完整文件的下载，它就可以反过来充当种子。 这些文件包含 元数据 有关要共享的文件的 跟踪 其他种子和对等点的跟踪器。2005 年，首先 Vuze ，然后是 BitTorrent 客户端引入了使用分布式哈希表的分布式跟踪，允许客户端直接在 swarm 上交换数据，而无需使用 torrent 文件。2006 年，添加了对等交换功能，允许客户端根据连接节点上的数据添加对等。

BitTorrent 协议可用于减少分发大文件对服务器和网络的影响。 BitTorrent 协议不是从单个源服务器下载文件，而是允许用户加入“群”主机以同时上传和下载。 该协议是用于分发数据的旧式单源、多镜像源技术的替代方案，并且可以在 带宽 。 使用 BitTorrent 协议，几台基本计算机（例如家用计算机）可以取代大型服务器，同时有效地将文件分发给许多收件人。 这种较低的带宽使用量还有助于防止给定区域的互联网流量，从而为所有用户保持更高的互联网速度，无论他们是否使用 BitTorrent 协议。 

### ZeroNet

ZeroNet 是一个点对点的网络，基于 BitTorrent 协议进行文件传输，且使用 BIP32 作为账户加密的基础，此外，ZeroNet 支持且仅支持 Bit 域名。为实现网站数据的存储，ZeroNet 发明了基于 P2P 的 SQL 数据库。

ZeroNet 号称零配置，但基于 BitTorrent 的网络协议造成了部分地区的运营商的网络阻塞。其次，ZeroNet 依赖中心化的用户注册中心 ZeroID，从2022年2月开始直至目前（2022年7月），ZeroID 出现了新用户注册的故障并没有维修的迹象。ZeroNet 是基于站点的系统，它支持拷贝网站，但没有官方工具，用户必须自行寻找方法下载整个站点并使用自己的签名重新部署新的站点，其复杂性阻拦了高级用户接手旧站点的开发。

综上，ZeroNet 实现了一个基于站点的网络，但因为并未使用区块链技术，站点与用户签名有强绑定。而基于域名币的域名与中心化账户明显有抢注风险，且造成 ID 无法转让。并未使用树结构管理站点数据的模式简化了数据结构，但也限制了站点数据拓展性，直接导致了站点的 fork 难以实现。因此，ZeroNet 可以被看作是一个内置签名认证与数据库同步的互联网的重新包装实现。

距今为止（2022年7月）ZeroNet 已停止开发两年，但 ZeroNet 的部分站点仍在持续更新内容。从中我们可以看到 P2P 网络去中心化的数据自治优势，即每个用户只需要保证自己关心的数据（单个站点/单个页面内容）的可用性而不需要关注整体（整个站点/整个网络）的完整性。

## 区块链

### IPFS

星际文件系统是一种点对点的分布式文件系统， 旨在连接所有有相同的文件系统的计算机设备。它使用 Bittorrent 网络协议，并使用 git 数据结构进行存储。IPFS 旨在构建一个单一的网络共享的巨型文件系统。与其他的 P2P 协议相同，IPFS 没有单故障点， 节点不需要相互信任。为解决数据共享的问题，IPFS 结合了分布式哈希表， 带有激励机制的块交换和自我认证命名空间来替代种子文件。目前，IPFS 被视为 Web3 的候选者之一。

考虑到人类可读性，IPFS 使用现有的 DNS 系统存储 IPNS 命名空间的别名，相较于 ZeroNet 的域名币方案，增加了可选的中心化的同时，减少了常规网站的迁移成本。

与纯粹的 Bittorrent 协议不同，IPFS 设计并内置了名为 BitSwap 的块交换协议。BitSwap 拥有一个独立的网络空间与积分账本，IPFS 客户端将自动从 BitSwap 空间中搜寻整个 IPFS 网络中的热点数据，并缓存它们，以期待他人发起的可能的数据传输来获取积分。在 IPFS 白皮书中，该协议有着完整的基于积分账本的攻击抵抗处理。但因为该积分不同于虚拟货币，对于节点本身不创造任何价值。所以，如 IPFS 白皮书所述，该协议过于理论化而难以执行。

在数据结构方面，IPFS 使用 Git 数据结构作为散列方式。Merkle DAG 拥有良好的 Web 兼容性，其寻址格式可平移切换到 HTTP 协议。此外它还拥有类似于 Git 的版本管理、拥有文件层级的概念、专门设计的加密数据结构支持、基于寻址格式与节点ID绑定的的防篡改。但与 Git 不同的是，IPFS 并非文件系统透明。其中存储的数据无法作为普通的文件夹存在于文件系统中，必须通过 IPFS 客户端的转换，目前计划实现作为镜像可读挂载的功能（截止到 2022年7月 暂未实现）。

### Filecoin

Filecoin 是一个基于 IPFS 的去中心化存储网络，它让云存储变成一个算法市场。这个市场运行在有着本地协议令牌（也叫做Filecoin）的区块链。区块链中的矿工可以通过为客户提供存储来获取 Filecoin，相反的，客户可以通过花费 Filecoin 来雇佣矿工来存储或分发数据。与其他区块链（包括 Chia）不同，Filecoin 挖矿行为本身提供了网络的基本功能，即存储数据并通过 PoRep 与 PoSt 证明保存的结果，而不仅仅只是作为验证非恶意的手段。

Filecoin 将计算能力本身视为可用资源，并与挖矿融合。相较于其他基于经济学账本的虚拟货币，针对具体应用，更容易被真实的应用系统采用，也避免了能耗浪费问题。

## 小结

以上数据传输方式证明并告诉了我们如何实现一个可靠且快速的 P2P 数据传输以及一些合适的现有方案。但我们项目的为了保证用户能在必要时切换更容易连接的网络，我们将试图兼容多种传输网络，因此，该系统将数据传输简单视为特定文件数据的改变。此外，我们还应该找到一种方法能快速踢出被视为恶意的节点，以保证网络的运行效率。

# 挖矿

## BTC

比特币是世界上一个完全点对点的电子货币，使用数字签名和 PoW（工作量证明）保证整个网络的账本安全性。其极简的通信网络协议设计，只需要保证信息被尽力广播，符合当代互联网的设计思想。因此，节点可以随时离开和重新加入网络，只需接受最长的工作量证明链作为它们离开时发生事件的证据。

面对恶意节点，比特币使用签名保证交易请求的有效性；通过跟踪足够多的交易记录来避免双花攻击（一枚硬币花多次）；对于回滚账本的攻击，比特币使用包括上一个区块信息的哈西函数，以层叠的方法避免生成“合法”的最长链，也使得发动攻击的收益远不及正常挖矿。

但因为比特币在设计之初就只考虑了账户转账等简单操作，基于栈的编程语言限制了它的应用，RPOW 的挖矿方法因浪费能源，也使其饱受争议。

## ETH

与比特币相同，以太坊构建了一个去中心化的账本。此外，以太坊的目标就是提供一个带有内置的成熟的图灵完备语言的区块链，用这种语言可以创建合约来编码任意状态转换功能，用户只要简单地用几行代码来实现逻辑，就能够创建以上提及的所有系统以及许多我们还想象不到的的其它系统。

以太坊以合约（函数）为中心，以太坊构建了一台去中心化的虚拟计算机，并得以实现金融应用、半金融应用与非金融应用这三大应用。和比特币一样，以太坊也有中心化风险，所以，以太坊还计划使用 PoS（权益证明）以替换能耗和抗中心化表现不佳的 PoW。

以太坊在发明之初就不是为任何已有的应用设计的，它旨在：围绕去中心化存储，去中心化计算和去中心化预测市场以及数十个类似概念建立的协议和去中心化应用，有潜力从根本上提升计算行业的效率，并通过首次添加经济层为其它的P2P协议提供有力支撑。这也导致以太坊是通用化，但发展方向并不清晰的。

## 小结

无论是比特币还是以太坊，以经济学账本为基础的加密货币都面临着不可信节点带来的问题，而泛化的设计使用场景使得更难以找到适合的解决方案。但可以肯定的是，随着技术发展成熟，在客户端性能日益强大的今天，Web3 将由更透明且更易于拓展的 P2P 应用构成。

# UPA 计算网络

UPA 计算网络认为在这个信息爆炸的互联网中，内容交换为基础的网络已体现其局限与低效，我们认为合理设立的网络应当以价值为基准，每个动作都应当对应价值。该网络的提出源于 UpgradeAll 应用期望去中心化的共享版本数据。因此，该网络需要满足快速（平均每个请求的时延低于3秒）、热插拔（支持用户自由地连接或断开网络）、数据校验与自动修正（避免单个节点故障或恶意节点）。再者，我们认为基于账本的分布式网络建立与纯粹的经济学基础上，与现代计算机工作机制不符，因此 UPA 计算网络将以函数计算为中心，对应于现实的人力劳动，账本只作为钱包存在，对应与现实的银行账户。此外，鉴于在以太坊或更接近该项目的 Golem Network 开发分布式应用的体验不佳，UPA 计算网络还应当支持开发几乎所有能够在现代计算机上运行的软件，并提供尽可能接近为真实的计算机环境开发软件的开发体验。

## 数据传输

参考 IPFS 与 ZeroNet，我们认为，为了更高的节点互联效率，我们必须根据“网络位置”（即网络跳数和延迟）与节点多少适当拆分网络。

针对于如何可靠的传输数据本身，我们已经有了 BT、WebRTC 此类协议。透过协议，我们可以不必自己实现网络传输的数据校验与踢除故意传输错误信息的恶意节点（但现有的协议尚不能判断并自动处理节点在逻辑上的错误或恶意攻击）。为了保障更快速的适配各个协议，我们参考 Linux 的虚拟文件系统，将数据模型以文件系统的方式映射到现有的文件模型上，通过这种透明文件系统，保证系统可以脱离网络协议甚至能直接运行在现有的分布式文件系统上。此外，通过抽象为文件，我们可以利用现有的 Git 工具管理与生成区块链结构。

![数据传输.svg](./svg/%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93.svg)

## 数据结构

为了便于缩减数据，我们将帐号数据、函数执行结果、函数运行时数据置于三个分离且设计不一的存储系统中，也就是存在于三个独立的文件夹里。其底层数据将参考 IPFS 压缩重复数据。

对于帐号系统，我们采用与以太坊相同的管理方式，简称为 A 文件系统。状态是由被称为“账户”（每个账户是一个短于32字节的地址）的对象和在两个账户之间转移价值和信息的状态转换构成的。

账户包含四个部分：

- 账户目前的余额
- 账户交易信息，包括交易关联的函数运行时数据的哈西指针与函数结果数据的哈西指针
- 账户的额外数据，作为函数存在，默认没有大小限制，但数据过大可能会被部分节点拒绝接受账户信息

该数据结构由 Git 支持，每一次“挖矿”结束，系统需要对该文件夹进行 commit 并广播，因此，帐号系统将拥有自动移除时间久远的本地 commit 数据的功能。此外，我们希望交易信息能够被自动合并并修剪被合并的 commit 以减少数据量与交易速度，作为系统维护的一部分，矿工可以通过合并操作获得相应的奖励代币（按节约的比特数计算）。为加快帐号查询的速度，类似于以太坊，该系统将拥有一个存在内存中的全局帐号表。

对于函数执行结果与函数运行时，一般它们的占用空间较多。且不需要长期保存，节点间也不必保证强一致性，因为节点只需要关心并处理和广播到它的函数数据，简称为 B 文件系统。

函数数据包含三个部分：

- 函数元数据
    - 请求信息
        - 帐号 ID
        - 发起的时间戳
        - 函数收益
    - 函数体可执行文件的哈西指针
    - 函数运行时数据文件的哈西指针的列表，因为可能包含多个运行时文件
- 函数可执行文件
- 函数运行时数据文件

故节点没有收到此类数据，对网络本身几乎没有影响。处理此类数据遗失的方法是：发起请求的节点等待一些时间后重新发起请求。因此，我们可以将函数数据视为可丢失且应当丢失旧数据的缓存数据类型。但为了防止节点计算完并成功生产一个区块后立即丢失函数结果，导致请求方无法获取到数据的问题，网络要求A文件系统必须包含校验前 10 个区块相关联的 B 文件系统的数据。在延迟10分钟后（即第60个区块），网络将发放计算收益。

### 优化

1. 网络中所有的数据均为懒加载，若希望加快挖矿/交易速度，节点可以自主缓存数据
2. 为便于查找，数据将以哈西桶的方式存储

## 计时方法

1. 以最新区块到前 5 个区块的所有交易的时间戳计算
    1. 每个交易需要注明发起时的最新区块 id 与当前的时间戳
    2. 每个区块打包的时间为 3 秒
2. 以区块数计算

## 代币质押

UPA 网络的任何账户操作都需要质押，可以是使用帐号持有的代币质押，也可以由其他帐号代为质押。

## 请求与收益

UPA 计算网络以函数计算的资源为中心，账本主要记录了网络中主要的两种交易模式：附带悬赏代币的函数计算请求与完成函数计算后所得到的收益。

UPA 网络的请求类似于以太坊交易。发起节点将悬赏的代币数与待运算的函数信息打包作为一个请求广播到网络中，然后等待其他节点运行函数再获取结果。工人节点将收集网络中广播的请求，并按照自己的偏好选择处理哪些请求（比如请求的时间尽量新，请求的报酬足够高）。

在以太坊或比特币中，节点可以通过处理交易账本来获取奖励的加密货币，但在本网络中，交易并不是第一公民，我们认为，运行函数才是真正有价值的，因此，函数甚至可以脱离账本，不做任何与账本有关的事情。例如，发布一个 0 收益的函数。所以，为了实现正常稳定的发币动作，我们将内置一些“网络维护脚本”与“官方应用脚本”，工人可以通过运行这些函数来获得奖励货币。

获得奖励的网络维护脚本如下：

- 传递/同步网络中除自己的信息外其他各节点的信息，即 A/B 文件系统
- 合并旧账本，合并老旧交易记录而得以删除久远的的交易记录，奖励按照合并的步骤数和账本历史时长发放（参考 以太坊 Layer 2 扩容方案）

作为 UPA 网络的原生应用 UpgradeAll，其默认请求函数的质押为 0，但工人仍然可以通过同步数据的方式获得奖励。

所有的交易都可以标记需要双方重复签名以保证交付完成。

## 挖矿

挖矿（英语：Mining），是指透过执行工作量证明或其他类似的电脑演算法来获取加密货币，例如比特币、以太币、莱特币等。由于此名称源自对采矿的比喻，进行挖矿工作的人通常称为矿工。 

与大部分加密货币一样，UPA 计算网络 也运行在默认不可信的节点上。因此，我们需要合理的方法阻止恶意攻击并达成系统的共识。与工作量证明不同，我们采用投票机制，即随机部分节点进行函数计算并校验其他节点发来的结果，打包结果相同或符合函数逻辑的节点（支持有随机数参与或其他正常结果可能不一致的函数）。

该系统的具体挖矿流程如下：

1. 获取网络中的函数请求，越新或者奖励越多的函数越可能被接受
2. 运算函数，节点可以按照资源消耗自行计算预期收益（类似与以太坊 gas）
3. 若节点运行完成或发现函数运行消耗过大而必须终止，打包函数有运行时，同时质押与奖励等值的代币，发布到网络
4. 等待其他节点交易工作成果，每个参与校验的节点都将把自己加入到打包数据的校验队列，同时质押与奖励等值的代币，发布到网络
5. 5%到最多32个节点校验完成后，每个校验节点获得1%的奖励，工人节点平均获得剩余奖励

## 网络分支

与其他加密货币不同，UPA 计算网络为了保证网络的运行效率，原生支持多链与分支链上数据的合并，其运行模式与现实中的银行类似。

为了方便理解，我们将 UPA 初始链称为主网，分支链称为支链。

我们认为有以下三种常见的情况（以主网分支为例）：

1. 因主网交易过多导致交易排队过长。部分节点希望暂时分支主网以加快交易/运算速度
2. 节点不希望在主网发布交易，希望隐藏交易细节（使用 ZK-Rollup 零知识证明）
3. 主网受到了攻击且攻击成功，诚信节点决定分叉以回滚

针对主网分支的步骤如下：

1. 帐号选择冻结想要分支去子网的额度
2. 节点发起分支函数请求

针对分支合并的步骤如下：

1. 合并请求
    1. 希望合并的节点向需要合并的账单/帐号金额等信息打包成主网交易发布，并在主网质押 10% 的代币或由其他帐号代为质押
    2. 合并节点选定账单，在主网质押合并账单交易额的 50%
    
    接下来，节点使用类似 Optimistic Rollups 方案进行合并
    
2. 开始合并
    1. 合并节点计算新的状态根（即默克尔根）
    2. 合并节点创建一笔以太坊交易，包含步骤3中所计算的状态根
    3. 合并网络开始处理合并节点发起的合并请求
        1. 发现虚假交易，罚没与虚假交易等额的代币，并拒绝交易
            1. 合并节点在分支网络发布虚假交易通知
            2. 分支网络标记虚假交易并对交易进行撤销
        2. 合并正常
3. 合并奖励
    1. 主网给合并节点的账户发送合并账单 1% 固定奖励外加合并请求等待的区块数个代币（最高10）的奖励
    2. 为鼓励分支节点合并，主网给被合并账户的主网帐号发送 0.01%合并的交易额（最高 1 个）代币奖励

## 函数运行时

UPA 将拥有原生虚拟机，可以以原生脚本的形式构建函数，此外也可以通过 LXC 等虚拟化技术运行自己的程序（请求构建虚拟环境额外为节点付费）

因此与函数相关的费用包括：

1. 原生脚本函数运行
2. 虚拟化环境初始化
3. 虚拟化环境运行费用

若节点认为预支的运行费用过多希望退还，若交易请求未明示退还账户，则退还到发起请求的账户。

## 中心化支持

为避免 The DAO 事件，UPA 网络添加了中心化支持

1. 函数可以标记自己拥有独裁者账户（管理员）或管理员签名
2. 函数可以标记参与者投票来撤销整个函数
    1. 发起函数需指明百分比为多少
3. 函数可以标记自己是可以被持有相同签名的函数覆盖的
    1. 发起函数需要标记每次更新后等待多少个区块或多久的现实时间
    2. 参与的账户在加入时可以选择是否跟随升级
    3. 每个升级完成后将等待时间中，已升级的账户可以选择回滚到任意版本
    4. 未升级的账户可以随时升级
